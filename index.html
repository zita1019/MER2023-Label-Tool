<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>MER2023 å¢å¼ºæ ‡æ³¨å¹³å° - æ–‡ä»¶çº§æ§åˆ¶ç‰ˆ</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>



    <style>
        :root {
            --sidebar-w: 280px;
            --header-h: 60px;
        }

        body {
            margin: 0;
            font-family: system-ui;
            display: grid;
            grid-template-columns: var(--sidebar-w) 1fr;
            grid-template-rows: var(--header-h) 1fr;
            height: 100vh;
            background: #f0f2f5;
            overflow: hidden;
        }

        header {
            grid-column: 1 / 3;
            background: #001529;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            z-index: 100;
        }

        /* å·¦ä¾§å¯¼èˆªæ å¸ƒå±€ */
        nav {
            background: #fff;
            border-right: 1px solid #d9d9d9;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #folder-list {
            padding: 10px;
            flex-shrink: 0;
            border-bottom: 2px solid #f0f0f0;
        }

        .file-list-container {
            flex-grow: 1;
            overflow-y: auto;
            background: #fafafa;
        }

        .list-header {
            padding: 10px;
            font-size: 12px;
            color: #999;
            background: #eee;
            position: sticky;
            top: 0;
        }

        .folder-btn {
            width: 100%;
            text-align: left;
            padding: 8px 12px;
            margin-bottom: 4px;
            border: none;
            background: #fff;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        .folder-btn.active {
            background: #1890ff;
            color: white;
            border-color: #1890ff;
        }

        .file-item {
            padding: 8px 15px;
            font-size: 13px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item:hover {
            background: #bae7ff;
        }

        .file-item.active {
            background: #e6f7ff;
            color: #1890ff;
            font-weight: bold;
            border-left: 4px solid #1890ff;
        }

        main {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }

        .video-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        video {
            width: 100%;
            background: #000;
            border-radius: 4px;
            aspect-ratio: 16 / 9;
        }

        .record-panel {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .full-row {
            grid-column: 1 / 3;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn-group {
            grid-column: 1 / 3;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            padding: 12px;
            border: none;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-ok {
            background: #52c41a;
        }

        .btn-mixed {
            background: #faad14;
        }

        .btn-skip {
            background: #bfbfbf;
        }

        #csv-preview {
            width: 100%;
            height: 120px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 11px;
            background: #f9f9f9;
        }
    </style>
</head>

<body>

    <header>
        <div style="font-size: 18px; font-weight: bold;">MER2023 æ ‡æ³¨ç³»ç»Ÿ (ç²¾ç¡®æ§åˆ¶ç‰ˆ)</div>
        <div id="user-display"></div>
    </header>

    <nav>
        <div id="folder-list"></div>
        <div class="list-header">æ–‡ä»¶åˆ—è¡¨ (ç‚¹å‡»è·³è½¬)</div>
        <div id="file-list" class="file-list-container"></div>
    </nav>

    <main>
        <div class="video-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items: center;">
                <span id="current-path" style="font-family: monospace; color:#1890ff; font-weight:bold;">è¯·å…ˆé€‰æ‹©å·¦ä¾§ç›®å½•</span>
                <span id="progress-text"
                    style="background:#f0f0f0; padding:2px 8px; border-radius:10px; font-size:12px;">0 / 0</span>
            </div>

            <video id="player" controls autoplay></video>

            <div class="record-panel" style="grid-template-columns: 1fr;">
                <div class="full-row">
                    <label>1. ä½ è®¤ä¸ºè§†é¢‘ä¸­çš„æƒ…ç»ªæ˜¯</label>
                    <div style="display: flex; gap: 30px; margin-top: 5px;">
                        <label style="font-weight: normal; display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="emotionType" value="Single" checked
                                style="width: auto; margin-right: 8px;"> å•ä¸€æƒ…ç»ª
                        </label>
                        <label style="font-weight: normal; display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="emotionType" value="Mixed"
                                style="width: auto; margin-right: 8px;"> æ··åˆæƒ…ç»ª
                        </label>
                    </div>
                </div>

                <div class="full-row">
                    <label>2. ä½ å¯¹ä½ çš„é€‰æ‹©çš„ç¡®ä¿¡åº¦æ˜¯ (1-5): <span id="conf-val" style="color:#1890ff">3</span></label>
                    <input type="range" id="conf" min="1" max="5" step="1" value="3"
                        oninput="document.getElementById('conf-val').innerText=this.value">
                </div>

                <div class="full-row">
                    <label>3. ä½ è®¤ä¸ºè¯¥æƒ…ç»ªçš„å”¤é†’åº¦ (1-5): <span id="arousal-val" style="color:#1890ff">3</span></label>
                    <input type="range" id="arousal" min="1" max="5" step="1" value="3"
                        oninput="document.getElementById('arousal-val').innerText=this.value">
                </div>

                <div class="btn-group" style="grid-column: 1 / 3;">
                    <button class="btn btn-ok" onclick="save()">ä¿å­˜ / ä¸‹ä¸€ä¸ª (Space)</button>
                    <button class="btn btn-skip" onclick="skip()">è·³è¿‡ (N)</button>
                </div>
            </div>
        </div>

        <textarea id="csv-preview" readonly placeholder="æ ‡æ³¨ç»“æœå®æ—¶é¢„è§ˆ..."></textarea>
        <button class="btn" style="background:#001529; margin-top:10px; width:200px;" onclick="downloadCSV()">å¯¼å‡º CSV
            ç»“æœæ–‡ä»¶</button>
    </main>

    <script src="data.js"></script>
    <script>
        // --- é…ç½®åŒº ---
        const BASE_URL = "https://mer2023-data-1404218931.cos.ap-chongqing.myqcloud.com/";
        // Supabase é…ç½®
        const supabaseUrl = "https://oykuesuwzycrspieezpx.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95a3Vlc3V3enljcnNwaWVlenB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3ODM0NjksImV4cCI6MjA4NjM1OTQ2OX0.J3j4ZgtgvqMVkZDw6zQSHTOgh_Ozn68mHKsSkj4pS0E";
        const _supabase = supabase.createClient(supabaseUrl, supabaseKey, {
            auth: {
                persistSession: false // ç¦ç”¨æŒä¹…åŒ–å­˜å‚¨ï¼Œç»•è¿‡æµè§ˆå™¨å¯¹å­˜å‚¨çš„æ‹¦æˆª
            }
        });

        let filteredList = [];
        let currentIndex = 0;
        let annotator = localStorage.getItem('mer_name') || "";

        window.onload = () => {
            if (!annotator) {
                annotator = prompt("è¯·è¾“å…¥æ ‡æ³¨å‘˜å§“åï¼š") || "Guest";
                localStorage.setItem('mer_name', annotator);
            }
            document.getElementById('user-display').innerText = "å½“å‰æ ‡æ³¨å‘˜: " + annotator;

            // è‡ªåŠ¨æå–æ–‡ä»¶å¤¹å±‚çº§
            const folders = [...new Set(rawData.map(i => i.Path.split('/')[0]))];
            const folderNav = document.getElementById('folder-list');

            folders.forEach(f => {
                const btn = document.createElement('button');
                btn.className = 'folder-btn';
                btn.innerText = "ğŸ“ " + f.toUpperCase();
                btn.onclick = () => {
                    document.querySelectorAll('.folder-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    filteredList = rawData.filter(i => i.Path.startsWith(f));
                    currentIndex = 0;
                    renderFileList(); // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    loadVideo();      // åŠ è½½ç¬¬ä¸€ä¸ªè§†é¢‘
                };
                folderNav.appendChild(btn);
            });
        };

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFileList() {
            const fileNav = document.getElementById('file-list');
            fileNav.innerHTML = "";
            filteredList.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.id = 'file-item-' + index;
                div.innerText = `${index + 1}. ${item.Name}`;
                div.onclick = () => {
                    currentIndex = index;
                    loadVideo();
                };
                fileNav.appendChild(div);
            });
        }

        function loadVideo() {
            if (!filteredList[currentIndex]) return;

            // 1. é«˜äº®å·¦ä¾§åˆ—è¡¨å¹¶æ»šåŠ¨
            document.querySelectorAll('.file-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.getElementById('file-item-' + currentIndex);
            if (activeItem) {
                activeItem.classList.add('active');
                activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // 2. è½¬æ¢è·¯å¾„å¹¶æ’­æ”¾
            let rawPath = filteredList[currentIndex].Path;
            let videoPath = rawPath.replace('.avi', '.mp4'); // å¼ºåˆ¶è½¬mp4

            document.getElementById('player').src = BASE_URL + videoPath;
            document.getElementById('current-path').innerText = videoPath;
            document.getElementById('progress-text').innerText = `${currentIndex + 1} / ${filteredList.length}`;

        }

        async function save() {
            const typeEls = document.getElementsByName('emotionType');
            let status = 'Single';
            for (let el of typeEls) { if (el.checked) status = el.value; }

            const arous = parseInt(document.getElementById('arousal').value);
            const conf = parseInt(document.getElementById('conf').value);
            const file = filteredList[currentIndex].Path;

            // A. æœ¬åœ°è®°å½•é€»è¾‘ (CSV é¢„è§ˆ)
            const line = `"${file}","${status}","${conf}","${arous}","${annotator}","${new Date().toLocaleString()}"\n`;
            document.getElementById('csv-preview').value += line;

            // B. å®æ—¶åŒæ­¥åˆ°äº‘ç«¯æ•°æ®åº“
            try {
                const { error } = await _supabase
                    .from('mer_labels')
                    .insert([
                        {
                            file_path: file,
                            label_type: status,
                            arousal: arous,
                            confidence: conf,
                            annotator: annotator
                        }
                    ]);
                if (error) {
                    console.error('Supabase Error:', error);
                    alert('æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å° (F12)');
                } else {
                    console.log('Saved to Supabase');
                }
            } catch (err) {
                console.error('Network Error:', err);
            }

            // é‡ç½® UI
            typeEls[0].checked = true;
            document.getElementById('arousal').value = 3;
            document.getElementById('arousal-val').innerText = 3;
            document.getElementById('conf').value = 3;
            document.getElementById('conf-val').innerText = 3;

            currentIndex++;
            if (currentIndex < filteredList.length) {
                loadVideo();
            } else {
                alert("æœ¬ç»„è§†é¢‘å·²å…¨éƒ¨æ ‡æ³¨å®Œæˆï¼");
            }
        }

        function skip() {
            currentIndex++;
            if (currentIndex < filteredList.length) loadVideo();
        }

        function downloadCSV() {
            const head = "File,Type,Confidence,Arousal,User,Timestamp\n";
            const content = head + document.getElementById('csv-preview').value;
            const blob = new Blob([content], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Label_${annotator}_${new Date().getTime()}.csv`;
            a.click();
        }

        // å¿«æ·é”®é€»è¾‘
        window.onkeydown = (e) => {
            if (e.code === 'Space' || e.key === 'Enter') {
                e.preventDefault();
                save();
            }
            if (e.key.toLowerCase() === 'n') skip();
            if (e.key === '1') document.getElementsByName('emotionType')[0].checked = true;
            if (e.key === '2') document.getElementsByName('emotionType')[1].checked = true;
        };
    </script>
</body>

</html>